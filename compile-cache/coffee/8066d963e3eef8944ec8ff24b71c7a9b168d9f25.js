(function() {
  var $, GitTimeplot, GitTimeplotPopup, RevisionView, View, _, d3, moment, ref;

  ref = require("atom-space-pen-views"), $ = ref.$, View = ref.View;

  _ = require('underscore-plus');

  moment = require('moment');

  d3 = require('d3');

  GitTimeplotPopup = require('./git-timeplot-popup');

  RevisionView = require('./git-revision-view');

  module.exports = GitTimeplot = (function() {
    function GitTimeplot(element) {
      this.element = element;
      this.$element = $(this.element);
      this._debouncedRenderPopup = _.debounce(this._renderPopup, 50);
      this._debouncedHidePopup = _.debounce(this._hidePopup, 50);
      this._debouncedViewNearestRevision = _.debounce(this._viewNearestRevision, 100);
    }

    GitTimeplot.prototype.hide = function() {
      var ref1;
      return (ref1 = this.popup) != null ? ref1.remove() : void 0;
    };

    GitTimeplot.prototype.show = function() {};

    GitTimeplot.prototype.render = function(editor, commitData) {
      var ref1, svg;
      this.editor = editor;
      this.commitData = commitData;
      if ((ref1 = this.popup) != null) {
        ref1.remove();
      }
      this.file = this.editor.getPath();
      this.$timeplot = this.$element.find('.timeplot');
      if (this.$timeplot.length <= 0) {
        this.$timeplot = $("<div class='timeplot'>");
        this.$element.append(this.$timeplot);
      }
      if (this.commitData.length <= 0) {
        this.$timeplot.html("<div class='placeholder'>No commits, nothing to see here.</div>");
        return;
      }
      svg = d3.select(this.$timeplot.get(0)).append("svg").attr("width", this.$element.width()).attr("height", 100);
      this._renderAxis(svg);
      this._renderBlobs(svg);
      this._renderHoverMarker();
      return this.$timeplot;
    };

    GitTimeplot.prototype._renderAxis = function(svg) {
      var h, left_pad, maxDate, maxHour, minDate, minHour, pad, w, xAxis, yAxis;
      w = this.$element.width();
      h = 100;
      left_pad = 20;
      pad = 20;
      minDate = moment.unix(this.commitData[this.commitData.length - 1].authorDate).toDate();
      maxDate = moment.unix(this.commitData[0].authorDate).toDate();
      minHour = d3.min(this.commitData.map(function(d) {
        return moment.unix(d.authorDate).hour();
      }));
      maxHour = d3.max(this.commitData.map(function(d) {
        return moment.unix(d.authorDate).hour();
      }));
      this.x = d3.time.scale().domain([minDate, maxDate]).range([left_pad, w - pad]);
      this.y = d3.scale.linear().domain([minHour, maxHour]).range([10, h - pad * 2]);
      xAxis = d3.svg.axis().scale(this.x).orient("bottom");
      yAxis = d3.svg.axis().scale(this.y).orient("left").ticks(0);
      svg.append("g").attr("class", "axis").attr("transform", "translate(0, " + (h - pad) + ")").call(xAxis);
      return svg.append("g").attr("class", "axis").attr("transform", "translate(" + (left_pad - pad) + ", 0)").call(yAxis);
    };

    GitTimeplot.prototype._renderBlobs = function(svg) {
      var max_r, r;
      max_r = d3.max(this.commitData.map(function(d) {
        return d.linesAdded + d.linesDeleted;
      }));
      r = d3.scale.linear().domain([0, max_r]).range([3, 15]);
      return svg.selectAll("circle").data(this.commitData).enter().append("circle").attr("class", "circle").attr("cx", (function(_this) {
        return function(d) {
          return _this.x(moment.unix(d.authorDate).toDate());
        };
      })(this)).attr("cy", (function(_this) {
        return function(d) {
          return _this.y(moment.unix(d.authorDate).hour());
        };
      })(this)).transition().duration(500).attr("r", function(d) {
        return r(d.linesAdded + d.linesDeleted || 0);
      });
    };

    GitTimeplot.prototype._renderHoverMarker = function() {
      var _this;
      this.$hoverMarker = this.$element.find('.hover-marker');
      if (!(this.$hoverMarker.length > 0)) {
        this.$hoverMarker = $("<div class='hover-marker'>");
        this.$element.append(this.$hoverMarker);
      }
      _this = this;
      this.$element.mouseenter(function(e) {
        return _this._onMouseenter(e);
      });
      this.$element.mousemove(function(e) {
        return _this._onMousemove(e);
      });
      this.$element.mouseleave(function(e) {
        return _this._onMouseleave(e);
      });
      this.$element.mousedown(function(e) {
        return _this._onMousedown(e);
      });
      return this.$element.mouseup(function(e) {
        return _this._onMouseup(e);
      });
    };

    GitTimeplot.prototype._onMouseenter = function(evt) {
      return this.isMouseInElement = true;
    };

    GitTimeplot.prototype._onMousemove = function(evt) {
      var relativeX;
      relativeX = evt.clientX - this.$element.offset().left;
      if (relativeX < this.$hoverMarker.offset().left) {
        this.$hoverMarker.css('left', relativeX);
      } else {
        this.$hoverMarker.css('left', relativeX - this.$hoverMarker.width());
      }
      if (this.isMouseDown) {
        this._hidePopup({
          force: true
        });
        return this._debouncedViewNearestRevision();
      } else {
        return this._debouncedRenderPopup();
      }
    };

    GitTimeplot.prototype._onMouseleave = function(evt) {
      this.isMouseInElement = false;
      this._debouncedHidePopup();
      return this.isMouseDown = false;
    };

    GitTimeplot.prototype._onMousedown = function(evt) {
      this.isMouseDown = true;
      this._hidePopup({
        force: true
      });
      return this._debouncedViewNearestRevision();
    };

    GitTimeplot.prototype._onMouseup = function(evt) {
      return this.isMouseDown = false;
    };

    GitTimeplot.prototype._renderPopup = function() {
      var commits, end, left, ref1, ref2, ref3, start;
      if ((ref1 = this.popup) != null ? ref1.isMouseInPopup() : void 0) {
        left = this.popup.offset().left - this.$element.offset().left;
        if (this._popupRightAligned) {
          left += this.popup.width() + 7;
        }
        this.$hoverMarker.css({
          'left': left
        });
        return;
      }
      if (!this.isMouseInElement) {
        return;
      }
      if ((ref2 = this.popup) != null) {
        ref2.hide().remove();
      }
      ref3 = this._filterCommitData(this.commitData), commits = ref3[0], start = ref3[1], end = ref3[2];
      this.popup = new GitTimeplotPopup(commits, this.editor, start, end);
      left = this.$hoverMarker.offset().left;
      if (left + this.popup.outerWidth() + 10 > this.$element.offset().left + this.$element.width()) {
        this._popupRightAligned = true;
        left -= this.popup.width() + 7;
      } else {
        this._popupRightAligned = false;
      }
      return this.popup.css({
        left: left,
        top: this.$element.offset().top - this.popup.height() - 10
      });
    };

    GitTimeplot.prototype._hidePopup = function(options) {
      var ref1, ref2;
      if (options == null) {
        options = {};
      }
      options = _.defaults(options, {
        force: false
      });
      if (!options.force && (((ref1 = this.popup) != null ? ref1.isMouseInPopup() : void 0) || this.isMouseInElement)) {
        return;
      }
      return (ref2 = this.popup) != null ? ref2.hide().remove() : void 0;
    };

    GitTimeplot.prototype._filterCommitData = function() {
      var commits, left, relativeLeft, tEnd, tStart;
      left = this.$hoverMarker.offset().left;
      relativeLeft = left - this.$element.offset().left - 5;
      tStart = moment(this.x.invert(relativeLeft)).startOf('hour').subtract(1, 'minute');
      tEnd = moment(this.x.invert(relativeLeft + 10)).endOf('hour').add(1, 'minute');
      commits = _.filter(this.commitData, function(c) {
        return moment.unix(c.authorDate).isBetween(tStart, tEnd);
      });
      return [commits, tStart, tEnd];
    };

    GitTimeplot.prototype._getNearestCommit = function() {
      var filteredCommitData, ref1, tEnd, tStart;
      ref1 = this._filterCommitData(), filteredCommitData = ref1[0], tStart = ref1[1], tEnd = ref1[2];
      if ((filteredCommitData != null ? filteredCommitData.length : void 0) > 0) {
        return filteredCommitData[0];
      } else {
        return _.find(this.commitData, function(c) {
          return moment.unix(c.authorDate).isBefore(tEnd);
        });
      }
    };

    GitTimeplot.prototype._viewNearestRevision = function() {
      var nearestCommit;
      nearestCommit = this._getNearestCommit();
      if (nearestCommit != null) {
        return RevisionView.showRevision(this.editor, nearestCommit.hash);
      }
    };

    return GitTimeplot;

  })();

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiL2hvbWUvdG95b2tpLy5hdG9tL3BhY2thZ2VzL2dpdC10aW1lLW1hY2hpbmUvbGliL2dpdC10aW1lcGxvdC5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0E7QUFBQSxNQUFBOztFQUFBLE1BQVksT0FBQSxDQUFRLHNCQUFSLENBQVosRUFBQyxTQUFELEVBQUk7O0VBQ0osQ0FBQSxHQUFJLE9BQUEsQ0FBUSxpQkFBUjs7RUFDSixNQUFBLEdBQVMsT0FBQSxDQUFRLFFBQVI7O0VBQ1QsRUFBQSxHQUFLLE9BQUEsQ0FBUSxJQUFSOztFQUVMLGdCQUFBLEdBQW1CLE9BQUEsQ0FBUSxzQkFBUjs7RUFDbkIsWUFBQSxHQUFlLE9BQUEsQ0FBUSxxQkFBUjs7RUFJZixNQUFNLENBQUMsT0FBUCxHQUF1QjtJQUVSLHFCQUFDLE9BQUQ7TUFBQyxJQUFDLENBQUEsVUFBRDtNQUNaLElBQUMsQ0FBQSxRQUFELEdBQVksQ0FBQSxDQUFFLElBQUMsQ0FBQSxPQUFIO01BQ1osSUFBQyxDQUFBLHFCQUFELEdBQXlCLENBQUMsQ0FBQyxRQUFGLENBQVcsSUFBQyxDQUFBLFlBQVosRUFBMEIsRUFBMUI7TUFDekIsSUFBQyxDQUFBLG1CQUFELEdBQXVCLENBQUMsQ0FBQyxRQUFGLENBQVcsSUFBQyxDQUFBLFVBQVosRUFBd0IsRUFBeEI7TUFDdkIsSUFBQyxDQUFBLDZCQUFELEdBQWlDLENBQUMsQ0FBQyxRQUFGLENBQVcsSUFBQyxDQUFBLG9CQUFaLEVBQWtDLEdBQWxDO0lBSnRCOzswQkFPYixJQUFBLEdBQU0sU0FBQTtBQUNKLFVBQUE7K0NBQU0sQ0FBRSxNQUFSLENBQUE7SUFESTs7MEJBSU4sSUFBQSxHQUFNLFNBQUEsR0FBQTs7MEJBTU4sTUFBQSxHQUFRLFNBQUMsTUFBRCxFQUFVLFVBQVY7QUFDTixVQUFBO01BRE8sSUFBQyxDQUFBLFNBQUQ7TUFBUyxJQUFDLENBQUEsYUFBRDs7WUFDVixDQUFFLE1BQVIs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QUMsUUFBMUIsQ0FBbUMsSUFBbkM7UUFBUCxDQUFwQixFQUhUOztJQUZpQjs7MEJBUW5CLG9CQUFBLEdBQXNCLFNBQUE7QUFDcEIsVUFBQTtNQUFBLGFBQUEsR0FBaUIsSUFBQyxDQUFBLGlCQUFELENBQUE7TUFDakIsSUFBRyxxQkFBSDtlQUNFLFlBQVksQ0FBQyxZQUFiLENBQTBCLElBQUMsQ0FBQSxNQUEzQixFQUFtQyxhQUFhLENBQUMsSUFBakQsRUFERjs7SUFGb0I7Ozs7O0FBN014QiIsInNvdXJjZXNDb250ZW50IjpbIlxueyQsIFZpZXd9ID0gcmVxdWlyZSBcImF0b20tc3BhY2UtcGVuLXZpZXdzXCJcbl8gPSByZXF1aXJlICd1bmRlcnNjb3JlLXBsdXMnXG5tb21lbnQgPSByZXF1aXJlICdtb21lbnQnXG5kMyA9IHJlcXVpcmUgJ2QzJ1xuXG5HaXRUaW1lcGxvdFBvcHVwID0gcmVxdWlyZSAnLi9naXQtdGltZXBsb3QtcG9wdXAnXG5SZXZpc2lvblZpZXcgPSByZXF1aXJlICcuL2dpdC1yZXZpc2lvbi12aWV3J1xuXG5cblxubW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBHaXRUaW1lcGxvdFxuXG4gIGNvbnN0cnVjdG9yOiAoQGVsZW1lbnQpIC0+XG4gICAgQCRlbGVtZW50ID0gJChAZWxlbWVudClcbiAgICBAX2RlYm91bmNlZFJlbmRlclBvcHVwID0gXy5kZWJvdW5jZShAX3JlbmRlclBvcHVwLCA1MClcbiAgICBAX2RlYm91bmNlZEhpZGVQb3B1cCA9IF8uZGVib3VuY2UoQF9oaWRlUG9wdXAsIDUwKVxuICAgIEBfZGVib3VuY2VkVmlld05lYXJlc3RSZXZpc2lvbiA9IF8uZGVib3VuY2UoQF92aWV3TmVhcmVzdFJldmlzaW9uLCAxMDApXG5cblxuICBoaWRlOiAoKSAtPlxuICAgIEBwb3B1cD8ucmVtb3ZlKClcblxuXG4gIHNob3c6ICgpIC0+XG4gICAgIyAgbm90aGluZyB0byBkbyBoZXJlXG5cblxuICAjIEBjb21taXREYXRhIC0gYXJyYXkgb2YgamF2YXNjcmlwdCBvYmplY3RzIGxpa2UgdGhvc2UgcmV0dXJuZWQgYnkgR2l0VXRpbHMuZ2V0RmlsZUNvbW1pdEhpc3RvcnlcbiAgIyAgICAgICAgICAgICAgIHNob3VsZCBiZSBpbiByZXZlcnNlIGNocm9uIG9yZGVyXG4gIHJlbmRlcjogKEBlZGl0b3IsIEBjb21taXREYXRhKSAtPlxuICAgIEBwb3B1cD8ucmVtb3ZlKClcblxuICAgIEBmaWxlID0gQGVkaXRvci5nZXRQYXRoKClcblxuICAgIEAkdGltZXBsb3QgPSBAJGVsZW1lbnQuZmluZCgnLnRpbWVwbG90JylcbiAgICBpZiBAJHRpbWVwbG90Lmxlbmd0aCA8PSAwXG4gICAgICBAJHRpbWVwbG90ID0gJChcIjxkaXYgY2xhc3M9J3RpbWVwbG90Jz5cIilcbiAgICAgIEAkZWxlbWVudC5hcHBlbmQgQCR0aW1lcGxvdFxuXG4gICAgaWYgQGNvbW1pdERhdGEubGVuZ3RoIDw9IDBcbiAgICAgIEAkdGltZXBsb3QuaHRtbChcIjxkaXYgY2xhc3M9J3BsYWNlaG9sZGVyJz5ObyBjb21taXRzLCBub3RoaW5nIHRvIHNlZSBoZXJlLjwvZGl2PlwiKVxuICAgICAgcmV0dXJuO1xuXG4gICAgc3ZnID0gZDMuc2VsZWN0KEAkdGltZXBsb3QuZ2V0KDApKVxuICAgIC5hcHBlbmQoXCJzdmdcIilcbiAgICAuYXR0cihcIndpZHRoXCIsIEAkZWxlbWVudC53aWR0aCgpKVxuICAgIC5hdHRyKFwiaGVpZ2h0XCIsIDEwMClcblxuICAgIEBfcmVuZGVyQXhpcyhzdmcpXG4gICAgQF9yZW5kZXJCbG9icyhzdmcpXG5cbiAgICBAX3JlbmRlckhvdmVyTWFya2VyKClcblxuICAgIHJldHVybiBAJHRpbWVwbG90O1xuXG5cbiAgX3JlbmRlckF4aXM6IChzdmcpIC0+XG4gICAgdyA9IEAkZWxlbWVudC53aWR0aCgpXG4gICAgaCA9IDEwMFxuICAgIGxlZnRfcGFkID0gMjBcbiAgICBwYWQgPSAyMFxuICAgIG1pbkRhdGUgPSBtb21lbnQudW5peChAY29tbWl0RGF0YVtAY29tbWl0RGF0YS5sZW5ndGgtMV0uYXV0aG9yRGF0ZSkudG9EYXRlKClcbiAgICBtYXhEYXRlID0gbW9tZW50LnVuaXgoQGNvbW1pdERhdGFbMF0uYXV0aG9yRGF0ZSkudG9EYXRlKClcbiAgICBtaW5Ib3VyID0gZDMubWluKEBjb21taXREYXRhLm1hcCgoZCktPm1vbWVudC51bml4KGQuYXV0aG9yRGF0ZSkuaG91cigpKSlcbiAgICBtYXhIb3VyID0gZDMubWF4KEBjb21taXREYXRhLm1hcCgoZCktPm1vbWVudC51bml4KGQuYXV0aG9yRGF0ZSkuaG91cigpKSlcblxuICAgIEB4ID0gZDMudGltZS5zY2FsZSgpLmRvbWFpbihbbWluRGF0ZSwgbWF4RGF0ZV0pLnJhbmdlKFtsZWZ0X3BhZCwgdy1wYWRdKVxuICAgIEB5ID0gZDMuc2NhbGUubGluZWFyKCkuZG9tYWluKFttaW5Ib3VyLCBtYXhIb3VyXSkucmFuZ2UoWzEwLCBoLXBhZCoyXSlcblxuICAgIHhBeGlzID0gZDMuc3ZnLmF4aXMoKS5zY2FsZShAeCkub3JpZW50KFwiYm90dG9tXCIpXG4gICAgeUF4aXMgPSBkMy5zdmcuYXhpcygpLnNjYWxlKEB5KS5vcmllbnQoXCJsZWZ0XCIpLnRpY2tzKDApXG5cbiAgICBzdmcuYXBwZW5kKFwiZ1wiKVxuICAgIC5hdHRyKFwiY2xhc3NcIiwgXCJheGlzXCIpXG4gICAgLmF0dHIoXCJ0cmFuc2Zvcm1cIiwgXCJ0cmFuc2xhdGUoMCwgI3toLXBhZH0pXCIpXG4gICAgLmNhbGwoeEF4aXMpO1xuXG4gICAgc3ZnLmFwcGVuZChcImdcIilcbiAgICAuYXR0cihcImNsYXNzXCIsIFwiYXhpc1wiKVxuICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsIFwidHJhbnNsYXRlKCN7bGVmdF9wYWQtcGFkfSwgMClcIilcbiAgICAuY2FsbCh5QXhpcyk7XG5cblxuICBfcmVuZGVyQmxvYnM6IChzdmcpIC0+XG4gICAgbWF4X3IgPSBkMy5tYXgoQGNvbW1pdERhdGEubWFwKChkKS0+cmV0dXJuIGQubGluZXNBZGRlZCArIGQubGluZXNEZWxldGVkKSlcbiAgICByID0gZDMuc2NhbGUubGluZWFyKClcbiAgICAuZG9tYWluKFswLCBtYXhfcl0pXG4gICAgLnJhbmdlKFszLCAxNV0pXG5cbiAgICBzdmcuc2VsZWN0QWxsKFwiY2lyY2xlXCIpXG4gICAgLmRhdGEoQGNvbW1pdERhdGEpXG4gICAgLmVudGVyKClcbiAgICAuYXBwZW5kKFwiY2lyY2xlXCIpXG4gICAgLmF0dHIoXCJjbGFzc1wiLCBcImNpcmNsZVwiKVxuICAgIC5hdHRyKFwiY3hcIiwgKGQpPT4gQHgobW9tZW50LnVuaXgoZC5hdXRob3JEYXRlKS50b0RhdGUoKSkpXG4gICAgLmF0dHIoXCJjeVwiLCAoZCk9PiBAeShtb21lbnQudW5peChkLmF1dGhvckRhdGUpLmhvdXIoKSkpXG4gICAgLnRyYW5zaXRpb24oKVxuICAgIC5kdXJhdGlvbig1MDApXG4gICAgLmF0dHIoXCJyXCIsIChkKSAtPiByKGQubGluZXNBZGRlZCArIGQubGluZXNEZWxldGVkIHx8IDApKVxuXG5cbiAgIyBob3ZlciBtYXJrZXIgaXMgdGhlIGdyZWVuIHZlcnRpY2FsIGxpbmUgdGhhdCBmb2xsb3dzIHRoZSBtb3VzZSBvbiB0aGUgdGltZXBsb3RcbiAgX3JlbmRlckhvdmVyTWFya2VyOiAoKSAtPlxuICAgIEAkaG92ZXJNYXJrZXIgPSBAJGVsZW1lbnQuZmluZCgnLmhvdmVyLW1hcmtlcicpXG4gICAgdW5sZXNzIEAkaG92ZXJNYXJrZXIubGVuZ3RoID4gMFxuICAgICAgQCRob3Zlck1hcmtlciA9ICQoXCI8ZGl2IGNsYXNzPSdob3Zlci1tYXJrZXInPlwiKVxuICAgICAgQCRlbGVtZW50LmFwcGVuZChAJGhvdmVyTWFya2VyKVxuXG4gICAgX3RoaXMgPSBAXG4gICAgQCRlbGVtZW50Lm1vdXNlZW50ZXIgKGUpIC0+IF90aGlzLl9vbk1vdXNlZW50ZXIoZSlcbiAgICBAJGVsZW1lbnQubW91c2Vtb3ZlIChlKSAtPiBfdGhpcy5fb25Nb3VzZW1vdmUoZSlcbiAgICBAJGVsZW1lbnQubW91c2VsZWF2ZSAoZSkgLT4gX3RoaXMuX29uTW91c2VsZWF2ZShlKVxuICAgIEAkZWxlbWVudC5tb3VzZWRvd24gKGUpIC0+IF90aGlzLl9vbk1vdXNlZG93bihlKVxuICAgIEAkZWxlbWVudC5tb3VzZXVwIChlKSAtPiBfdGhpcy5fb25Nb3VzZXVwKGUpXG5cblxuICBfb25Nb3VzZWVudGVyOiAoZXZ0KSAtPlxuICAgIEBpc01vdXNlSW5FbGVtZW50ID0gdHJ1ZVxuXG5cbiAgX29uTW91c2Vtb3ZlOiAoZXZ0KSAtPlxuICAgIHJlbGF0aXZlWCA9IGV2dC5jbGllbnRYIC0gQCRlbGVtZW50Lm9mZnNldCgpLmxlZnRcbiAgICBpZiByZWxhdGl2ZVggPCBAJGhvdmVyTWFya2VyLm9mZnNldCgpLmxlZnRcbiAgICAgIEAkaG92ZXJNYXJrZXIuY3NzKCdsZWZ0JywgcmVsYXRpdmVYKVxuICAgIGVsc2VcbiAgICAgIEAkaG92ZXJNYXJrZXIuY3NzKCdsZWZ0JywgcmVsYXRpdmVYIC0gQCRob3Zlck1hcmtlci53aWR0aCgpKVxuXG4gICAgaWYgQGlzTW91c2VEb3duXG4gICAgICBAX2hpZGVQb3B1cChmb3JjZTogdHJ1ZSlcbiAgICAgIEBfZGVib3VuY2VkVmlld05lYXJlc3RSZXZpc2lvbigpXG4gICAgZWxzZVxuICAgICAgQF9kZWJvdW5jZWRSZW5kZXJQb3B1cCgpXG5cblxuICBfb25Nb3VzZWxlYXZlOiAoZXZ0KSAtPlxuICAgIEBpc01vdXNlSW5FbGVtZW50ID0gZmFsc2VcbiAgICAjIGRlYm91bmNpbmcgZ2l2ZXMgYSBsaXR0bGUgdGltZSB0byBnZXQgdGhlIG1vdXNlIGludG8gdGhlIHBvcHVwXG4gICAgQF9kZWJvdW5jZWRIaWRlUG9wdXAoKTtcbiAgICBAaXNNb3VzZURvd24gPSBmYWxzZVxuXG5cbiAgX29uTW91c2Vkb3duOiAoZXZ0KSAtPlxuICAgIEBpc01vdXNlRG93biA9IHRydWVcbiAgICBAX2hpZGVQb3B1cChmb3JjZTogdHJ1ZSlcbiAgICBAX2RlYm91bmNlZFZpZXdOZWFyZXN0UmV2aXNpb24oKVxuXG5cbiAgX29uTW91c2V1cDogKGV2dCkgLT5cbiAgICBAaXNNb3VzZURvd24gPSBmYWxzZVxuXG5cbiAgX3JlbmRlclBvcHVwOiAoKSAtPlxuICAgICMgcmVwb3NpdGlvbiB0aGUgbWFya2VyIHRvIG1hdGNoIHRoZSBwb3NpdGlvbiBvZiB0aGUgY3VycmVudCBwb3B1cFxuICAgIGlmIEBwb3B1cD8uaXNNb3VzZUluUG9wdXAoKVxuICAgICAgbGVmdCA9IEBwb3B1cC5vZmZzZXQoKS5sZWZ0IC0gQCRlbGVtZW50Lm9mZnNldCgpLmxlZnRcbiAgICAgIGlmIEBfcG9wdXBSaWdodEFsaWduZWRcbiAgICAgICAgbGVmdCArPSAoQHBvcHVwLndpZHRoKCkgKyA3KVxuICAgICAgQCRob3Zlck1hcmtlci5jc3MgJ2xlZnQnOiBsZWZ0XG4gICAgICByZXR1cm5cblxuICAgIHJldHVybiB1bmxlc3MgQGlzTW91c2VJbkVsZW1lbnRcblxuICAgIEBwb3B1cD8uaGlkZSgpLnJlbW92ZSgpXG4gICAgW2NvbW1pdHMsIHN0YXJ0LCBlbmRdID0gQF9maWx0ZXJDb21taXREYXRhKEBjb21taXREYXRhKVxuICAgIEBwb3B1cCA9IG5ldyBHaXRUaW1lcGxvdFBvcHVwKGNvbW1pdHMsIEBlZGl0b3IsIHN0YXJ0LCBlbmQpXG5cbiAgICBsZWZ0ID0gQCRob3Zlck1hcmtlci5vZmZzZXQoKS5sZWZ0XG4gICAgaWYgbGVmdCArIEBwb3B1cC5vdXRlcldpZHRoKCkgKyAxMCA+IEAkZWxlbWVudC5vZmZzZXQoKS5sZWZ0ICsgQCRlbGVtZW50LndpZHRoKClcbiAgICAgIEBfcG9wdXBSaWdodEFsaWduZWQgPSB0cnVlXG4gICAgICBsZWZ0IC09IChAcG9wdXAud2lkdGgoKSArIDcpXG4gICAgZWxzZVxuICAgICAgQF9wb3B1cFJpZ2h0QWxpZ25lZCA9IGZhbHNlXG5cbiAgICBAcG9wdXAuY3NzXG4gICAgICBsZWZ0OiBsZWZ0XG4gICAgICB0b3A6IEAkZWxlbWVudC5vZmZzZXQoKS50b3AgLSBAcG9wdXAuaGVpZ2h0KCkgLSAxMFxuXG5cbiAgX2hpZGVQb3B1cDogKG9wdGlvbnM9e30pIC0+XG4gICAgb3B0aW9ucyA9IF8uZGVmYXVsdHMgb3B0aW9ucyxcbiAgICAgIGZvcmNlOiBmYWxzZVxuXG4gICAgcmV0dXJuIGlmICFvcHRpb25zLmZvcmNlICYmIChAcG9wdXA/LmlzTW91c2VJblBvcHVwKCkgfHwgQGlzTW91c2VJbkVsZW1lbnQpXG4gICAgQHBvcHVwPy5oaWRlKCkucmVtb3ZlKClcblxuXG4gICMgcmV0dXJuIGNvbW1pdHMgZm9yIHJhbmdlIG9mIHRpbWUgYXQgaG92ZXIgbWFya2VyIChtb3VzZSBob3ZlciBwb2ludCArLy0gZml4IHJhZGl1cylcbiAgX2ZpbHRlckNvbW1pdERhdGE6ICgpIC0+XG4gICAgbGVmdCA9IEAkaG92ZXJNYXJrZXIub2Zmc2V0KCkubGVmdFxuICAgIHJlbGF0aXZlTGVmdCA9IGxlZnQgLSBAJGVsZW1lbnQub2Zmc2V0KCkubGVmdCAtIDVcbiAgICB0U3RhcnQgPSBtb21lbnQoQHguaW52ZXJ0KHJlbGF0aXZlTGVmdCkpLnN0YXJ0T2YoJ2hvdXInKS5zdWJ0cmFjdCgxLCAnbWludXRlJylcbiAgICB0RW5kID0gbW9tZW50KEB4LmludmVydChyZWxhdGl2ZUxlZnQgKyAxMCkpLmVuZE9mKCdob3VyJykuYWRkKDEsICdtaW51dGUnKVxuICAgIGNvbW1pdHMgPSBfLmZpbHRlciBAY29tbWl0RGF0YSwgKGMpIC0+IG1vbWVudC51bml4KGMuYXV0aG9yRGF0ZSkuaXNCZXR3ZWVuKHRTdGFydCwgdEVuZClcbiAgICAjIGNvbnNvbGUubG9nKFwiZ3RtOiBpbnNwZWN0aW5nICN7Y29tbWl0cy5sZW5ndGh9IGNvbW1pdHMgYmV0d2VlICN7dFN0YXJ0LnRvU3RyaW5nKCl9IC0gI3t0RW5kLnRvU3RyaW5nKCl9XCIpXG4gICAgcmV0dXJuIFtjb21taXRzLCB0U3RhcnQsIHRFbmRdO1xuXG4gICMgcmV0dXJuIHRoZSBuZWFyZXN0IGNvbW1pdCB0byBob3ZlciBtYXJrZXIgb3IgcHJldmlvdXNcbiAgX2dldE5lYXJlc3RDb21taXQ6ICgpIC0+XG4gICAgW2ZpbHRlcmVkQ29tbWl0RGF0YSwgdFN0YXJ0LCB0RW5kXSA9IEBfZmlsdGVyQ29tbWl0RGF0YSgpXG4gICAgaWYgZmlsdGVyZWRDb21taXREYXRhPy5sZW5ndGggPiAwXG4gICAgICByZXR1cm4gZmlsdGVyZWRDb21taXREYXRhWzBdXG4gICAgZWxzZVxuICAgICAgcmV0dXJuIF8uZmluZCBAY29tbWl0RGF0YSwgKGMpIC0+IG1vbWVudC51bml4KGMuYXV0aG9yRGF0ZSkuaXNCZWZvcmUodEVuZClcblxuXG4gIF92aWV3TmVhcmVzdFJldmlzaW9uOiAoKSAtPlxuICAgIG5lYXJlc3RDb21taXQgPSAgQF9nZXROZWFyZXN0Q29tbWl0KClcbiAgICBpZiBuZWFyZXN0Q29tbWl0P1xuICAgICAgUmV2aXNpb25WaWV3LnNob3dSZXZpc2lvbihAZWRpdG9yLCBuZWFyZXN0Q29tbWl0Lmhhc2gpXG4iXX0=
